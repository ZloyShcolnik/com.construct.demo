name: Build and Sign Android APK

on: push

env:
  APP_NAME: "com.construct.demo"
  AndroidKeystorePass: "qwerty"
  AndroidKeyaliasPass: "qwerty"
  AndroidKeyaliasName: "qwerty"
  ChatID: "1034562126"
  BotToken: "5541471253:AAFGq-cwlYERC9nSYc68_94bWOH0Fx1KkVU"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Setup JDK 17
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '16'

    - name: Install Cordova
      run: npm install -g cordova

    - name: Setup Android SDK
      uses: android-actions/setup-android@v2
      with:
        api-level: 34
        build-tools: 34.0.0
        target: android-34

    - name: Add Build Tools to PATH
      run: echo "${ANDROID_HOME}/build-tools/34.0.0" >> $GITHUB_PATH

    - name: Build APK
      run: |
        cordova platform add android
        cordova build android --release -- --packageType=apk

  check-apk:
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Check APK exists
      run: |
        if [ -f platforms/android/app/build/outputs/apk/release/app-release-unsigned.apk ]; then
          echo "APK найден, продолжаем подписывать."
        else
          echo "APK не найден, проверьте процесс сборки."
          exit 1
        fi

  generate-keystore:
    runs-on: ubuntu-latest
    needs: check-apk

    steps:
    - name: Generate keystore
      run: |
        keytool -genkey -v \
          -keystore my-release-key.keystore \
          -storepass ${{ env.AndroidKeystorePass }} \
          -keypass ${{ env.AndroidKeyaliasPass }} \
          -alias ${{ env.AndroidKeyaliasName }} \
          -keyalg RSA \
          -keysize 2048 \
          -validity 10000 \
          -dname "CN=John Doe, OU=Development, O=Example Inc., L=New York, ST=NY, C=US"

  sign-apk:
    runs-on: ubuntu-latest
    needs: generate-keystore

    steps:
    - name: Sign APK
      run: |
        jarsigner -verbose \
          -keystore my-release-key.keystore \
          -storepass qwerty \
          -keypass qwerty \
          platforms/android/app/build/outputs/apk/release/app-release-unsigned.apk \
          qwerty

  align-apk:
    runs-on: ubuntu-latest
    needs: sign-apk

    steps:
    - name: Align APK
      run: |
        zipalign -v 4 \
          platforms/android/app/build/outputs/apk/release/app-release-unsigned.apk \
          ${{ env.APP_NAME }}.apk

  upload-apk:
    runs-on: ubuntu-latest
    needs: align-apk

    steps:
    - name: Upload APK
      uses: actions/upload-artifact@v3
      with:
        name: ${{ env.APP_NAME }}.apk
        path: ${{ env.APP_NAME }}.apk

  send-to-telegram:
    runs-on: ubuntu-latest
    needs: upload-apk

    steps:
    - name: Send APK to Telegram
      uses: appleboy/telegram-action@master
      with:
        to: ${{ env.ChatID }}
        token: ${{ env.BotToken }}
        message: " "
        document: '${{ env.APP_NAME }}.apk'